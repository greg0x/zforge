services:
  zebra:
    # Pre-built image: ghcr.io/zcashfoundation/zebra:edge
    # Built from ZcashFoundation/zebra:main - commit 7a7572f (2025-10-29)
    # Run 'docker compose build' to build locally from ./zebra submodule instead
    image: ghcr.io/zcashfoundation/zebra:edge
    build:
      context: ./zebra
      dockerfile: docker/Dockerfile
      target: runtime
    container_name: z3_zebra
    restart: unless-stopped
    platform: ${DOCKER_PLATFORM:-linux/amd64}
    env_file:
      - ./.env
    environment:
      - RUST_LOG=${Z3_ZEBRA_RUST_LOG}
      - ZEBRA_NETWORK__NETWORK=${NETWORK_NAME}
      - ZEBRA_RPC__ENABLE_COOKIE_AUTH=${ENABLE_COOKIE_AUTH}
      - ZEBRA_RPC__COOKIE_DIR=${COOKIE_AUTH_FILE_DIR}
    volumes:
      # Blockchain state (defaults to named volume 'zebra_data')
      - ${Z3_ZEBRA_DATA_PATH}:/home/zebra/.cache/zebra
      # Cookie authentication shared with Zaino and Zallet
      - ${Z3_COOKIE_PATH}:${COOKIE_AUTH_FILE_DIR}
    ports:
      - "${Z3_ZEBRA_HOST_RPC_PORT}:${Z3_ZEBRA_RPC_PORT}"
      - "${Z3_ZEBRA_HOST_HEALTH_PORT}:8080"
    networks:
      - z3_net
    healthcheck:
      # Verifies Zebra is synced near network tip (default: within 2 blocks)
      # For fresh sync: run 'docker compose up -d zebra' first, wait for sync,
      # then run 'docker compose up -d' to start full stack
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:8080/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  zaino:
    # Pre-built image: ghcr.io/zcashfoundation/zaino:edge
    # Built from zingolabs/zaino:dev - commit 2e2c768 (2025-11-04)
    # Run 'docker compose build' to build locally from ./zaino submodule instead
    image: ghcr.io/zcashfoundation/zaino:edge
    build:
      context: ./zaino
      dockerfile: Dockerfile
    container_name: z3_zaino
    restart: unless-stopped
    depends_on:
      zebra:
        condition: service_healthy
    env_file:
      - ./.env
    environment:
      - RUST_LOG=${ZAINO_RUST_LOG}
      - RUST_BACKTRACE=${ZAINO_RUST_BACKTRACE}
      - ZAINO_NETWORK=${NETWORK_NAME}
      # Zebra connection and authentication
      - ZAINO_VALIDATOR_LISTEN_ADDRESS=zebra:${Z3_ZEBRA_RPC_PORT}
      - ZAINO_VALIDATOR_COOKIE_AUTH=${ENABLE_COOKIE_AUTH}
      - ZAINO_VALIDATOR_COOKIE_PATH=${COOKIE_AUTH_FILE_DIR}/.cookie
      # Zaino RPC services
      - ZAINO_GRPC_LISTEN_ADDRESS=0.0.0.0:${ZAINO_GRPC_PORT}
      - ZAINO_JSON_RPC_LISTEN_ADDRESS=0.0.0.0:${ZAINO_JSON_RPC_PORT}
      # TLS configuration
      - ZAINO_GRPC_TLS=${ZAINO_GRPC_TLS_ENABLE}
      - ZAINO_TLS_CERT_PATH=${ZAINO_GRPC_TLS_CERT_PATH}
      - ZAINO_TLS_KEY_PATH=${ZAINO_GRPC_TLS_KEY_PATH}
    volumes:
      # Indexer state (defaults to named volume 'zaino_data')
      - ${Z3_ZAINO_DATA_PATH}:/home/zaino/.cache/zaino
      # Cookie authentication
      - ${Z3_COOKIE_PATH}:${COOKIE_AUTH_FILE_DIR}:ro
    configs:
      - source: zaino_tls_cert
        target: ${ZAINO_GRPC_TLS_CERT_PATH}
      - source: zaino_tls_key
        target: ${ZAINO_GRPC_TLS_KEY_PATH}
    ports:
      - "${ZAINO_HOST_GRPC_PORT}:${ZAINO_GRPC_PORT}"
      - "${ZAINO_HOST_JSONRPC_PORT}:${ZAINO_JSON_RPC_PORT}"
    networks:
      - z3_net
    healthcheck:
      # Process check (gRPC cannot be directly curled)
      test: ["CMD-SHELL", "/usr/local/bin/zainod --version >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  zallet:
    # Pre-built image: ghcr.io/zcashfoundation/zallet:edge
    # Built from zcash/wallet:main - commit a7148cd (2025-10-31)
    # Run 'docker compose build' to build locally from ./zallet submodule instead
    image: ghcr.io/zcashfoundation/zallet:edge
    build:
      context: ./zallet
      dockerfile: Dockerfile
    container_name: z3_zallet
    restart: unless-stopped
    user: "65532:65532"
    command: ["--datadir", "/var/lib/zallet", "start"]
    depends_on:
      zaino:
        condition: service_healthy
    env_file:
      - ./.env
    environment:
      - RUST_LOG=${ZALLET_RUST_LOG}
      - ZALLET_NETWORK=${NETWORK_NAME}
      - ZALLET_RPC_BIND=0.0.0.0:${ZALLET_RPC_PORT}
    volumes:
      # Wallet database (defaults to named volume 'zallet_data')
      - ${Z3_ZALLET_DATA_PATH}:/var/lib/zallet
      # Cookie authentication for Zebra access
      - ${Z3_COOKIE_PATH}:${COOKIE_AUTH_FILE_DIR}:ro
      # Configuration files
      - ./config/zallet.toml:/var/lib/zallet/zallet.toml:ro
      - ./config/zallet_identity.txt:/var/lib/zallet/identity.txt:ro
    ports:
      - "${ZALLET_HOST_RPC_PORT}:${ZALLET_RPC_PORT}"
    networks:
      - z3_net
    # NOTE: Healthcheck disabled - distroless image has no shell/curl
    # Zallet will restart automatically if it crashes (restart: unless-stopped)
    # Monitor logs or use external monitoring for service health

volumes:
  zebra_data:
  zaino_data:
  zallet_data:
  shared_cookie_volume:

networks:
  z3_net:
    driver: bridge

configs:
  zaino_tls_cert:
    file: ./config/tls/zaino.crt
  zaino_tls_key:
    file: ./config/tls/zaino.key
