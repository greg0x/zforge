# Z3 Docker Compose - Regtest Deployment
#
# For CI, automated testing, or running on a shared dev server.
# Local development should use: overmind start
#
# Usage:
#   docker compose build                    # Build images with patched submodules
#   docker compose up -d                    # Start services
#   docker compose logs -f                  # Follow logs

services:
  zebra:
    build:
      context: .
      dockerfile: Dockerfile.zebra
    container_name: z3_zebra
    restart: unless-stopped
    volumes:
      - zebra_data:/data/zebra
      - ./config/zebra-docker.toml:/etc/zebra/config.toml:ro
    ports:
      - "18232:18232"   # RPC
      - "8080:8080"     # Health/metrics
    networks:
      - z3_net
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:8080/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    command: ["-c", "/etc/zebra/config.toml"]

  zaino:
    build:
      context: .
      dockerfile: Dockerfile.zaino
    container_name: z3_zaino
    restart: unless-stopped
    depends_on:
      zebra:
        condition: service_healthy
    volumes:
      - zaino_data:/data/zaino
      - ./config/zaino-docker.toml:/etc/zaino/config.toml:ro
    ports:
      - "8137:8137"     # gRPC (lightwalletd protocol)
    networks:
      - z3_net
    healthcheck:
      test: ["CMD-SHELL", "zainod --version >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    command: ["-c", "/etc/zaino/config.toml"]

volumes:
  zebra_data:
  zaino_data:

networks:
  z3_net:
    driver: bridge
