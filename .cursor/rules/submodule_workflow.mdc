---
description: Workflow for making changes in Git submodules
globs: ["zebra/**", "zaino/**", "orchard/**", "librustzcash/**", "zcash-devtool/**"]
alwaysApply: false
---

# Submodule Workflow

## Use ./dev git Commands

**Always use `./dev git` for multi-repo operations:**

```bash
./dev git status          # Status across all repos
./dev git branch <name>   # Create feature branch
./dev git commit <msg>    # Commit across submodules
./dev git push            # Push all repos
./dev git sync            # Fetch upstream
```

## Making Protocol Changes

```bash
# 1. Start feature branch (creates in orchard + librustzcash by default)
./dev git branch add-tag-field

# 2. Make changes in submodules
cd orchard
# ... edit files ...

# 3. Commit across all dirty repos + update main repo pointer
./dev git commit "Add tag field to Action struct"

# 4. Push everything
./dev git push
```

## Branch Structure (All Forks)

```
main          → Z3-compatible development (DEFAULT)
feature/*     → Feature branches (branch from main)
upstream/main → Remote ref only (for upstream PRs)
```

## Contributing Changes Upstream

For submitting PRs to official upstream repositories:

```bash
cd orchard  # or any submodule
git fetch upstream
git checkout -b pr/feature-xyz upstream/main  # Branch from upstream's main
git cherry-pick <commits>                      # Pick your commits
git push origin pr/feature-xyz                 # Push to your fork
# Open PR: your-fork/orchard:pr/feature-xyz → zcash/orchard:main
```

## Version Compatibility

All submodules must use compatible versions:
- **orchard**: 0.11.x
- **sapling-crypto**: 0.5.x
- **zcash_client_backend**: 0.21.x
- **zcash_keys**: 0.12.x

These constraints exist because Zebra hasn't updated to newer orchard/sapling versions.

## For AI Agents

When making changes to files in submodules:

1. Use `./dev git branch <name>` to start a feature
2. Edit files in submodule directories
3. Use `./dev git commit "message"` to commit everywhere
4. Use `./dev git push` to push all repos
5. Both submodule and main repo commits require `required_permissions: ['git_write']`
6. Follow commit message guidelines from commit_guidelines.mdc
7. Never use raw `git` commands for routine operations
