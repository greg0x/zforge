---
description: Branch workflow for z3 and submodules
globs: []
alwaysApply: true
---

# Branch Workflow

## Structure

**Main z3 repo:**
- `main` - Primary development branch (submodules track `main`)

**All submodules (zebra, zaino, orchard, librustzcash, zcash-devtool):**
- `main` - Z3 development base (DEFAULT, pinned to compatible versions)
- `feature/*` - Feature branches (branch from `main`)
- `pr/*` - Upstream PR branches (branch from `upstream/main`)

**Note:** `upstream/main` is a remote ref, not a local branch. Use `git fetch upstream` to update it.

## Daily Workflow

```bash
# Start a new feature
cd orchard
git checkout main
git pull origin main
git checkout -b feature/add-tag-field
# ... make changes ...
git commit -m "Add tag field to Action struct"
git push origin feature/add-tag-field

# When feature is ready, merge to main
git checkout main
git merge feature/add-tag-field
git push origin main

# Update main z3 repo
cd ..
git add orchard
git commit -m "Update orchard with tag field changes"
```

## Upstream Contribution Workflow

When ready to contribute changes upstream:

```bash
cd orchard
git fetch upstream                           # Get latest upstream
git checkout -b pr/add-tag-field upstream/main   # Branch from upstream
git cherry-pick <commits>                    # Pick your commits
git push origin pr/add-tag-field             # Push to your fork

# Open PR: your-fork/orchard:pr/add-tag-field â†’ zcash/orchard:main
```

## Syncing with Upstream

When you want to pull in upstream changes to your `main`:

```bash
cd orchard
git fetch upstream
git checkout main
git merge upstream/main   # Or rebase if preferred
# Resolve any conflicts
git push origin main

# Update z3 main repo
cd ..
git add orchard
git commit -m "Sync orchard with upstream changes"
```

## Version Compatibility

All submodule `main` branches must use compatible versions:
- orchard 0.11.x / sapling-crypto 0.5.x (Zebra constraint)
- zcash_client_backend 0.21.x / zcash_keys 0.12.x

Run `scripts/setup-fork-branches.sh` to verify/fix compatibility.

## Agent Instructions

When making changes in submodules:
1. Ensure you're on `main` or a `feature/*` branch
2. Feature branches should branch from `main`
3. For upstream PRs, create `pr/*` branches from `upstream/main`
4. Never force-push to `main` without coordination
5. Always test that changes compile with other submodules
